<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prism</title>
  <style>
    :root{
      --bg1:#020617; --bg2:#0b1220; --text:#e5e7eb; --muted:#94a3b8;
      --ink:#a5b4fc; --indigo:#6366f1; --panel:rgba(255,255,255,0.04);
      --border:rgba(255,255,255,0.1); --danger:#dc2626; --ok:#10b981;
    }
    *{box-sizing:border-box}
    html,body{margin:0; height:100%; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; background: radial-gradient(circle at 10% 10%, #0a0f1f 0%, #000 60%) fixed; color:var(--text)}
    a{color:inherit; text-decoration:none}
    .container{max-width:1000px; margin:0 auto; padding:0 16px 80px}
    header{position:sticky; top:0; backdrop-filter: blur(8px); border-bottom:1px solid var(--border); background:rgba(255,255,255,0.02); z-index:10}
    header .row{display:flex; align-items:center; justify-content:space-between; padding:12px 0}
    nav a{padding:8px 12px; border-radius:12px; color:#cbd5e1}
    nav a:hover{background:rgba(255,255,255,0.08); color:white}
    nav a.active{background:rgba(255,255,255,0.12); color:white; outline:1px solid rgba(255,255,255,0.08)}
    .logo{display:flex; align-items:center; gap:8px}
    .grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .tile{position:relative; overflow:hidden; border:1px solid var(--border); background:var(--panel); border-radius:20px; padding:24px; transition:.2s}
    .tile:hover{background:rgba(255,255,255,0.08)}
    .card{border:1px solid var(--border); background:var(--panel); border-radius:20px; padding:24px; box-shadow:inset 0 1px 0 rgba(255,255,255,0.06)}
    .muted{color:var(--muted)}
    .btn{display:inline-block; background:#4f46e5; color:white; padding:10px 14px; border-radius:12px; border:0; cursor:pointer}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .btn:hover{background:#6366f1}
    .btn-danger{background:var(--danger)} .btn-danger:hover{background:#ef4444}
    .btn-ok{background:var(--ok)} .btn-ok:hover{filter:brightness(1.1)}
    footer{margin-top:32px; display:flex; justify-content:space-between; color:#94a3b8; font-size:14px}
    .stars::before{content:""; position:fixed; inset:0; background-image:radial-gradient(rgba(99,102,241,0.08) 1px, transparent 1px); background-size:24px 24px; opacity:.4; pointer-events:none}
    textarea,input,select{width:100%; background:rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.15); color:var(--text); padding:10px 12px; border-radius:12px}
    textarea{min-height:90px; resize:vertical}
    .list{list-style:none; margin:0; padding:0}
    .post{border:1px solid var(--border); background:var(--panel); border-radius:14px; padding:16px}
    .row{display:flex; gap:8px; align-items:center}
    .row-wrap{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:rgba(0,0,0,.25); cursor:pointer}
    .pill:hover{background:rgba(255,255,255,0.06)}
    .count{font-size:12px; color:#a5b4fc}
    .toast{position:fixed; left:50%; bottom:22px; transform:translateX(-50%); background:rgba(16,185,129,0.15); border:1px solid rgba(16,185,129,0.35); color:#d1fae5; padding:10px 14px; border-radius:12px; box-shadow:0 6px 30px rgba(16,185,129,0.25); z-index:50}

    /* Eyes */
    .eyeShell{height:220px; display:grid; place-items:center}
    .eyes{display:flex; gap:24px}
    .eye{position:relative; height:110px; width:110px; border-radius:50%; background:rgba(255,255,255,0.9); border:1px solid rgba(255,255,255,0.3); box-shadow: inset 0 8px 30px rgba(0,0,0,.35), 0 2px 30px rgba(99,102,241,.35); overflow:hidden}
    .eye::before{content:""; position:absolute; inset:0; background:radial-gradient(circle at 50% 30%, rgba(226,232,240,.9), rgba(203,213,225,.8), transparent 70%)}
    .pupil{position:absolute; top:50%; left:50%; height:36px; width:36px; background:#1e1b4b; border-radius:50%; transform:translate(-50%,-50%);}
    .pupil::after{content:""; position:absolute; inset:4px; background:#4f46e5; border-radius:50%}

    /* Cursor trail particles */
    .particle{position:fixed;width:8px;height:8px;border-radius:50%;pointer-events:none;will-change:transform,opacity;filter:blur(0.2px)}
    @keyframes pop{from{transform:translate(var(--x),var(--y)) scale(1);opacity:1}to{transform:translate(calc(var(--x)*2),calc(var(--y)*2)) scale(0);opacity:0}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="stars">
  <div class="container">
    <header>
      <div class="row" style="justify-content:space-between">
        <div class="logo">
          <svg width="28" height="28" viewBox="0 0 64 64" aria-hidden>
            <polygon points="32,6 58,54 6,54" fill="none" stroke="#818cf8" stroke-width="2"></polygon>
            <line x1="0" y1="22" x2="28" y2="28" stroke="#cbd5e1" stroke-width="2"></line>
            <line x1="36" y1="30" x2="64" y2="18" stroke="#fb7185" stroke-width="2"></line>
            <line x1="36" y1="32" x2="64" y2="32" stroke="#34d399" stroke-width="2"></line>
            <line x1="36" y1="34" x2="64" y2="46" stroke="#22d3ee" stroke-width="2"></line>
          </svg>
          <div style="font-weight:600; letter-spacing:.08em; font-size:20px">Prism</div>
        </div>
        <nav>
          <a href="#home" id="navHome">Home</a>
          <a href="#stories" id="navStories">Stories</a>
          <a href="#fun" id="navFun">Fun</a>
        </nav>
      </div>
    </header>

    <main id="app" style="padding-top:24px"></main>

    <footer>
      <div>¬© <span id="year"></span> Prism. Forged in the void.</div>
      <div class="muted">Alien-sleek starter ¬∑ Free deploy</div>
    </footer>
  </div>

  <script>
    // ====== CONFIG: your Supabase keys ======
    const SUPABASE_URL = "https://niynqtpppdzrciozjcvr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5peW5xdHBwcGR6cmNpb3pqY3ZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MTAyODcsImV4cCI6MjA3MjA4NjI4N30.lnlXM9lzfdOaCW6UQ5fBZ_SHd8TOVF0KCgpSsTrMbgs";
    // =======================================

    document.getElementById('year').textContent = new Date().getFullYear();
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- Helpers ----------
    function h(tag, attrs={}, ...children){
      const el = document.createElement(tag);
      for(const k in attrs){
        if(k.startsWith('on') && typeof attrs[k]==='function'){ el.addEventListener(k.slice(2).toLowerCase(), attrs[k]); }
        else if(k==='html'){ el.innerHTML = attrs[k]; }
        else { el.setAttribute(k, attrs[k]); }
      }
      for(const c of children){ if(c==null) continue; el.append(c.nodeType ? c : document.createTextNode(c)); }
      return el;
    }
    // Escape ONLY < and > on render (so & and " stay literal)
    const esc = (s) => String(s).replace(/[<>]/g, m => ({'<':'&lt;','>':'&gt;'}[m]));
    function toast(msg){ const t = h('div',{class:'toast'}, msg); document.body.appendChild(t); setTimeout(()=>t.remove(),1600); }
    const choose = (arr)=>arr[Math.floor(Math.random()*arr.length)];
    function setActiveNav(){
      const hash = location.hash || '#home';
      document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));
      if(hash.startsWith('#stories')) document.getElementById('navStories').classList.add('active');
      else if(hash.startsWith('#fun')) document.getElementById('navFun').classList.add('active');
      else document.getElementById('navHome').classList.add('active');
    }
    const neon = () => {
      const hueBands = [[200,260],[160,190],[300,330],[180,200]];
      const [a,b] = choose(hueBands);
      const h = Math.floor(a + Math.random()*(b-a));
      return `hsla(${h} 95% 65% / 1)`;
    };

    // ---------- Identity ----------
    const LAST_PEN_KEY='prism_last_pen';
    const LAST_MASK_KEY='prism_last_mask';
    const LAST_RESERVED='prism_reserved';
    const MASKS = [
      "Grey","Reptilian","Nordic","Insectoid","Cyborg Alien",
      "Retro Martian","Roswell Cartoon","Xeno-Beast","Space Wizard",
      "Cosmic Jellyfish","Nebula Face","Crystal Skull","Obsidian Fox",
      "Solar Phantom","Void Wraith"
    ];

    function sha256Hex(s){
      const enc = new TextEncoder().encode(s);
      return crypto.subtle.digest('SHA-256', enc).then(buf =>
        Array.from(new Uint8Array(buf)).map(x=>x.toString(16).padStart(2,'0')).join('')
      );
    }
    async function reservePen(pen, mask, password){
      const password_hash = password ? await sha256Hex(password) : null;
      const { data, error } = await supabase.from('users').upsert([{ pen, mask, password_hash }], { onConflict: 'pen' }).select();
      if(error) throw error;
      return data?.[0] || null;
    }
    async function dbGetUser(pen){
      const { data, error } = await supabase.from('users').select('*').eq('pen', pen).maybeSingle();
      if(error) throw error;
      return data;
    }

    // ---------- Supabase (Stories / Comments / Reactions) ----------
    const MAX_LEN = 2000;
    const COOLDOWN_MS = 10_000;
    const DUP_WINDOW_MS = 120_000;
    const ALLOWED_EMOJIS = ["üëç","üòÇ","üî•","üëΩ"];

    async function dbFetchStories(){
      return await supabase
        .from('stories')
        .select('id, pen, text, created_at')
        .order('created_at', {ascending:false})
        .limit(200);
    }
    async function dbFetchStoriesByPen(pen){
      return await supabase
        .from('stories')
        .select('id, pen, text, created_at')
        .eq('pen', pen)
        .order('created_at', {ascending:false})
        .limit(200);
    }
    async function dbInsertStory(pen, text){
      return await supabase.from('stories').insert([{ pen, text }]).select();
    }

    async function dbInsertComment(story_id, pen, text){
      return await supabase.from('comments').insert([{ story_id, pen, text }]).select();
    }
    async function dbFetchComments(story_id){
      return await supabase.from('comments')
        .select('id, story_id, pen, text, created_at')
        .eq('story_id', story_id)
        .order('created_at',{ascending:true});
    }

    async function dbReact(story_id, pen, emoji){
      await supabase.from('reactions').delete().match({ story_id, pen, emoji });
      return await supabase.from('reactions').insert([{ story_id, pen, emoji }]).select();
    }
    async function dbReactionTotals(story_id){
      const { data, error } = await supabase.from('reactions')
        .select('emoji, count:emoji', { count: 'exact', head: false })
        .eq('story_id', story_id);
      if(error) return { totals:{} };
      const totals = { "üëç":0,"üòÇ":0,"üî•":0,"üëΩ":0 };
      for(const r of data){ if(ALLOWED_EMOJIS.includes(r.emoji)) totals[r.emoji] = (totals[r.emoji]||0)+1; }
      return { totals };
    }

    // ---------- Mask SVG previews ----------
    function maskSVG(type){
      const svg = (inner)=>{ const s = h('svg',{viewBox:'0 0 64 64',width:48,height:48, style:'filter:drop-shadow(0 0 6px rgba(99,102,241,.6))'}); s.innerHTML = inner; return s; };
      const glow = '#7c83ff', line = '#bcd3ff';
      switch(type){
        case 'Grey': return svg(`<ellipse cx="32" cy="36" rx="18" ry="22" fill="none" stroke="${glow}" stroke-width="2"/><ellipse cx="24" cy="36" rx="6" ry="8" fill="${line}"/><ellipse cx="40" cy="36" rx="6" ry="8" fill="${line}"/>`);
        case 'Reptilian': return svg(`<path d="M12 40 Q32 10 52 40 Q32 58 12 40Z" fill="none" stroke="${glow}" stroke-width="2"/><path d="M22 36 Q26 32 30 36" stroke="${line}" stroke-width="3"/><path d="M34 36 Q38 32 42 36" stroke="${line}" stroke-width="3"/>`);
        case 'Nordic': return svg(`<circle cx="32" cy="32" r="18" fill="none" stroke="${glow}" stroke-width="2"/><circle cx="26" cy="30" r="3" fill="${line}"/><circle cx="38" cy="30" r="3" fill="${line}"/>`);
        case 'Insectoid': return svg(`<ellipse cx="32" cy="34" rx="20" ry="16" fill="none" stroke="${glow}" stroke-width="2"/><ellipse cx="24" cy="34" rx="7" ry="9" fill="${line}"/><ellipse cx="40" cy="34" rx="7" ry="9" fill="${line}"/>`);
        case 'Cyborg Alien': return svg(`<rect x="16" y="16" width="32" height="32" rx="10" fill="none" stroke="${glow}" stroke-width="2"/><circle cx="26" cy="32" r="5" fill="${line}"/><rect x="34" y="28" width="12" height="8" fill="${line}"/>`);
        case 'Retro Martian': return svg(`<circle cx="32" cy="34" r="16" fill="none" stroke="${glow}" stroke-width="2"/><line x1="28" y1="18" x2="24" y2="10" stroke="${line}" stroke-width="2"/><line x1="36" y1="18" x2="40" y2="10" stroke="${line}" stroke-width="2"/>`);
        case 'Roswell Cartoon': return svg(`<ellipse cx="32" cy="34" rx="16" ry="18" fill="none" stroke="${glow}" stroke-width="2"/><circle cx="26" cy="34" r="5" fill="${line}"/><circle cx="38" cy="34" r="5" fill="${line}"/>`);
        case 'Xeno-Beast': return svg(`<path d="M16 46 Q32 10 48 46" fill="none" stroke="${glow}" stroke-width="2"/><path d="M22 34 L28 36" stroke="${line}" stroke-width="3"/><path d="M42 34 L36 36" stroke="${line}" stroke-width="3"/>`);
        case 'Space Wizard': return svg(`<path d="M12 28 L32 8 L52 28 V52 H12Z" fill="none" stroke="${glow}" stroke-width="2"/><circle cx="32" cy="36" r="4" fill="${line}"/>`);
        case 'Cosmic Jellyfish': return svg(`<circle cx="32" cy="28" r="12" fill="none" stroke="${glow}" stroke-width="2"/><path d="M20 40 Q24 48 28 40 Q32 48 36 40 Q40 48 44 40" stroke="${line}" stroke-width="2" fill="none"/>`);
        case 'Nebula Face': return svg(`<circle cx="32" cy="32" r="18" fill="none" stroke="${glow}" stroke-width="2"/><circle cx="26" cy="30" r="2" fill="${line}"/><circle cx="38" cy="34" r="2" fill="${line}"/>`);
        case 'Crystal Skull': return svg(`<path d="M20 18 H44 V40 L32 50 L20 40 Z" fill="none" stroke="${glow}" stroke-width="2"/><line x1="20" y1="28" x2="44" y2="28" stroke="${line}" stroke-width="2"/>`);
        case 'Obsidian Fox': return svg(`<path d="M16 28 L24 16 L32 26 L40 16 L48 28 V48 H16Z" fill="none" stroke="${glow}" stroke-width="2"/><circle cx="26" cy="34" r="3" fill="${line}"/><circle cx="38" cy="34" r="3" fill="${line}"/>`);
        case 'Solar Phantom': return svg(`<circle cx="32" cy="32" r="16" fill="none" stroke="${glow}" stroke-width="2"/><path d="M16 32 A16 16 0 0 0 48 32" stroke="${line}" stroke-width="2" fill="none"/>`);
        case 'Void Wraith': return svg(`<path d="M16 20 Q32 10 48 20 V48 H16Z" fill="none" stroke="${glow}" stroke-width="2"/><circle cx="28" cy="30" r="2" fill="${line}"/><circle cx="36" cy="30" r="2" fill="${line}"/>`);
        default: return svg(`<circle cx="32" cy="32" r="18" fill="none" stroke="${glow}" stroke-width="2"/>`);
      }
    }

    // ---------- Stories (page) ----------
    function Stories(){
      const wrapper = h('div', {});
      let items = [];
      let viewingPen = null;

      // Identity panel with visual mask preview
      const penInput = h('input', {placeholder:'Pen name', maxlength:'40', value: localStorage.getItem(LAST_PEN_KEY) || ''});
      const maskSel  = h('select',{}, ...MASKS.map(m=>h('option',{value:m, selected: (localStorage.getItem(LAST_MASK_KEY)||'Grey')===m}, m)));
      const maskPreview = h('div',{class:'row', style:'gap:12px;align-items:center'});
      function renderMaskPreview(){
        maskPreview.innerHTML = '';
        maskPreview.append(maskSVG(maskSel.value), h('div', {class:'muted'}, maskSel.value));
      }
      renderMaskPreview();
      maskSel.addEventListener('input', renderMaskPreview);

      const pwInput  = h('input', {placeholder:'Password (optional to reserve)', type:'password'});
      const saveIdBtn= h('button',{class:'btn', onclick: saveIdentity}, 'Save / Reserve');
      const who = h('div',{class:'muted'});

      async function saveIdentity(){
        const p = penInput.value.trim(); if(!p){ alert('Enter a pen name'); return; }
        const m = maskSel.value;
        const pw = pwInput.value.trim();
        try{
          if(pw){
            await reservePen(p, m, pw);
            localStorage.setItem(LAST_RESERVED,'1');
            toast('Pen name reserved üîí');
          }else{
            localStorage.removeItem(LAST_RESERVED);
            toast('Identity saved (guest)');
          }
          localStorage.setItem(LAST_PEN_KEY, p);
          localStorage.setItem(LAST_MASK_KEY, m);
          renderWho();
        }catch(err){
          alert('Could not save identity: ' + (err?.message||err));
        }
      }

      function renderWho(){
        const p = localStorage.getItem(LAST_PEN_KEY)||'(none)';
        const m = localStorage.getItem(LAST_MASK_KEY)||'Grey';
        const r = localStorage.getItem(LAST_RESERVED)? '‚Äî reserved üîí' : '‚Äî guest';
        who.textContent = `You are ${p} (${m}) ${r}`;
      }
      renderWho();

      const idCard = Card('Identity',
        'Passwords are optional ‚Äî setting one reserves your Pen Name so no one else can claim it.',
        h('div',{},
          h('div',{class:'grid', style:'grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:12px'},
            penInput, maskSel, pwInput
          ),
          h('div',{style:'margin-top:8px'}, maskPreview),
          h('div',{class:'row', style:'margin-top:10px'}, saveIdBtn),
          h('div',{style:'margin-top:6px'}, who)
        )
      );

      // composer
      const form = h('form', {onsubmit: (e)=>{ e.preventDefault(); add(); }});
      const text = h('textarea', {placeholder:`Share a thought (max ${MAX_LEN} chars)‚Ä¶`, maxlength:String(MAX_LEN)});
      const count = h('span', {class:'count'}, '0/' + MAX_LEN);
      const postBtn = h('button', {class:'btn', type:'submit', disabled:true}, 'Post');
      const refreshBtn = h('button', {class:'btn', type:'button', onclick:()=>load(true)}, 'Refresh');

      text.addEventListener('input', () => { count.textContent = text.value.length + '/' + MAX_LEN; validate(); });
      penInput.addEventListener('input', validate);

      function cooldownReady(){
        const last = Number(localStorage.getItem('prism_last_post_at')||0);
        return Date.now() - last >= COOLDOWN_MS;
      }
      function validate(){
        const ok = penInput.value.trim().length>0 && text.value.trim().length>0 && cooldownReady();
        postBtn.disabled = !ok;
      }

      form.append(
        h('div', {class:'grid', style:'grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:12px'},
          text
        ),
        h('div', {class:'row', style:'justify-content:space-between; margin-top:10px'},
          count,
          h('div', {class:'row'}, postBtn, refreshBtn)
        )
      );

      // Feed card (newest first)
      const listCard = Card('Community feed', 'Newest first ¬∑ click a pen name to see their archive', h('div', {}, 'Loading‚Ä¶'));
      const listBody = listCard.lastChild;

      function isClientDuplicate(p, t){
        const clean = s => s.trim().replace(/\s+/g,' ');
        const now = Date.now();
        return items.some(e =>
          e.pen.trim() === clean(p) &&
          e.text.trim() === clean(t) &&
          (now - new Date(e.created_at).getTime()) < DUP_WINDOW_MS
        );
      }

      async function add(){
        if(!cooldownReady()){
          const left = Math.ceil((COOLDOWN_MS - (Date.now()-Number(localStorage.getItem('prism_last_post_at')||0)))/1000);
          alert('Easy there, warp drive cooling down‚Ä¶ try again in ~' + left + 's.');
          return;
        }
        const p = penInput.value.trim(), t = text.value.trim();
        if(!p || !t) return;
        if(isClientDuplicate(p, t)){ alert('Looks like you just posted that. Not posting a duplicate.'); return; }

        postBtn.innerHTML = '<span class="spin"></span> Posting‚Ä¶';
        postBtn.disabled = true;

        const { data, error } = await dbInsertStory(p, t);
        if(error){
          alert('Could not post: ' + (error.message||''));
          postBtn.textContent = 'Post'; validate();
          return;
        }

        localStorage.setItem('prism_last_post_at', String(Date.now()));
        text.value = ''; count.textContent = '0/' + MAX_LEN;

        await load(true);
        postBtn.textContent = 'Posted!';
        setTimeout(()=>{ postBtn.textContent = 'Post'; validate(); }, 900);
      }

      async function load(showSpinner){
        if(showSpinner) listBody.innerHTML = 'Loading‚Ä¶';
        let resp;
        if(viewingPen) resp = await dbFetchStoriesByPen(viewingPen);
        else resp = await dbFetchStories();
        const { data, error } = resp;
        if(error){ listBody.innerHTML = 'Could not load: ' + error.message; return; }
        items = data || [];
        renderList();
      }

      function renderList(){
        const ul = h('ul', {class:'list'});
        if(items.length === 0){
          ul.append(h('div',{class:'muted'}, viewingPen ? `No entries yet for ${viewingPen}.` : 'No entries yet. Be the first to post!'));
        } else {
          for(const it of items){
            const card = h('li',{class:'post', style:'margin-top:12px'});
            const header = h('div',{class:'row', style:'justify-content:space-between'},
              h('div',{},
                h('a',{href:'#stories?pen='+encodeURIComponent(it.pen), onclick:(e)=>{e.preventDefault(); viewingPen=it.pen; load(true);} , style:'color:#a5b4fc; font-weight:600; letter-spacing:.02em'}, esc(it.pen))
              ),
              h('time',{class:'muted'}, new Date(it.created_at).toLocaleString())
            );
            const body = h('div',{style:'margin-top:8px; white-space:pre-wrap'}, esc(it.text));

            // Reactions
            const reactRow = h('div',{class:'row-wrap', style:'margin-top:10px'});
            const totalsEl = h('div',{class:'muted'});
            ALLOWED_EMOJIS.forEach(em=>{
              reactRow.append(h('span',{class:'pill', onclick:()=>toggleReact(it.id, em)}, em));
            });
            reactRow.append(totalsEl);

            // Comments
            const commentsWrap = h('div',{style:'margin-top:10px'});
            const commentInput = h('input',{placeholder:'Add a comment‚Ä¶'});
            const commentBtn = h('button',{class:'btn', onclick:()=>sendComment(it.id, commentInput)}, 'Comment');

            commentsWrap.append(
              h('div',{class:'row-wrap'}, commentInput, commentBtn),
              h('div',{id:'c-'+it.id, style:'margin-top:8px'})
            );

            card.append(header, body, reactRow, commentsWrap);
            ul.append(card);

            updateReactions(it.id, totalsEl);
            loadComments(it.id);
          }
        }
        listBody.innerHTML = '';
        if(viewingPen){
          listBody.append(
            h('div',{class:'row-wrap', style:'margin-bottom:8px'},
              h('span',{class:'muted'}, 'Viewing ' + viewingPen + ' ‚Äî '),
              h('button',{class:'btn', onclick:()=>{ viewingPen=null; load(true); }}, 'Back to all')
            )
          );
        }
        listBody.append(ul);
      }

      async function toggleReact(storyId, emoji){
        const pen = penInput.value.trim(); if(!pen){ alert('Set your Pen Name first'); return; }
        if(!ALLOWED_EMOJIS.includes(emoji)) return;
        await dbReact(storyId, pen, emoji);
        updateReactions(storyId, null);
      }
      async function updateReactions(storyId, target){
        const { totals } = await dbReactionTotals(storyId);
        const s = `Reactions: üëç ${totals["üëç"]||0} ¬∑ üòÇ ${totals["üòÇ"]||0} ¬∑ üî• ${totals["üî•"]||0} ¬∑ üëΩ ${totals["üëΩ"]||0}`;
        if(target) target.textContent = s;
      }

      async function sendComment(storyId, inputEl){
        const pen = penInput.value.trim(); if(!pen){ alert('Set your Pen Name first'); return; }
        const txt = inputEl.value.trim(); if(!txt) return;
        inputEl.disabled = true;
        try{
          await dbInsertComment(storyId, pen, txt);
          inputEl.value = '';
          loadComments(storyId);
        }catch(err){ alert('Could not comment: ' + (err?.message||err)); }
        inputEl.disabled = false;
      }
      async function loadComments(storyId){
        const { data, error } = await dbFetchComments(storyId);
        const target = document.getElementById('c-'+storyId);
        if(!target) return;
        if(error){ target.textContent = 'Could not load comments.'; return; }
        target.innerHTML = (data||[]).map(c =>
          `<div style="margin:6px 0"><b style="color:#c7d2fe">${esc(c.pen)}</b>: ${esc(c.text)} <small class="muted">(${new Date(c.created_at).toLocaleString()})</small></div>`
        ).join('');
      }

      wrapper.append(idCard, h('div',{style:'height:10px'}), Card('Write a story','Shared across devices via Supabase',
        (()=>{
          const form = document.createElement('div'); form.append(...document.querySelectorAll('form')); return form;
        })()
      ));
      // Rebuild composer correctly (the IIFE above wouldn‚Äôt work in isolation), so append directly:
      wrapper.append(
        Card('Write a story','Shared across devices via Supabase',
          (()=>{
            const form = document.createElement('form');
            form.onsubmit = (e)=>{ e.preventDefault(); add(); };
            const text = document.createElement('textarea');
            text.placeholder = `Share a thought (max ${MAX_LEN} chars)‚Ä¶`;
            text.maxLength = MAX_LEN;
            const count = h('span',{class:'count'},'0/'+MAX_LEN);
            const postBtn = h('button',{class:'btn',type:'submit',disabled:true},'Post');
            const refreshBtn = h('button',{class:'btn',type:'button',onclick:()=>load(true)},'Refresh');

            function cooldownReady(){ const last=Number(localStorage.getItem('prism_last_post_at')||0); return Date.now()-last>=COOLDOWN_MS;}
            function validate(){ const ok=(penInput.value.trim().length>0 && text.value.trim().length>0 && cooldownReady()); postBtn.disabled=!ok; }
            text.addEventListener('input', ()=>{ count.textContent = text.value.length + '/' + MAX_LEN; validate(); });
            penInput.addEventListener('input', validate);

            form.append(
              h('div',{class:'grid',style:'grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px'}, text),
              h('div',{class:'row',style:'justify-content:space-between;margin-top:10px'}, count, h('div',{class:'row'}, postBtn, refreshBtn))
            );
            // expose functions in closure:
            Stories.__text = text; Stories.__postBtn = postBtn; Stories.__validate = validate; Stories.__add = add; Stories.__load = load;
            return form;
          })()
        )
      );

      // Feed
      const feed = Card('Community feed','Newest first ¬∑ click a pen name to see their archive', h('div', {}, 'Loading‚Ä¶'));
      wrapper.append(h('div',{style:'height:14px'}), feed);
      const listBody = feed.lastChild;

      // fix references after creating composer
      function postCardLoad(){ Stories.__load && Stories.__load(true); }
      const textRef = ()=>Stories.__text;

      // Rewire add/load to use correct refs
      async function add(){
        const cooldownReady=()=>{ const last=Number(localStorage.getItem('prism_last_post_at')||0); return Date.now()-last>=COOLDOWN_MS;}
        if(!cooldownReady()){
          const left = Math.ceil((COOLDOWN_MS - (Date.now()-Number(localStorage.getItem('prism_last_post_at')||0)))/1000);
          alert('Easy there, warp drive cooling down‚Ä¶ try again in ~' + left + 's.');
          return;
        }
        const p = penInput.value.trim(), t = textRef().value.trim();
        if(!p || !t) return;
        if(isClientDuplicate(p, t)){ alert('Looks like you just posted that. Not posting a duplicate.'); return; }

        Stories.__postBtn.innerHTML = '<span class="spin"></span> Posting‚Ä¶';
        Stories.__postBtn.disabled = true;

        const { data, error } = await dbInsertStory(p, t);
        if(error){
          alert('Could not post: ' + (error.message||''));
          Stories.__postBtn.textContent = 'Post'; Stories.__validate();
          return;
        }

        localStorage.setItem('prism_last_post_at', String(Date.now()));
        textRef().value = ''; document.querySelector('.count').textContent = '0/' + MAX_LEN;

        await load(true);
        Stories.__postBtn.textContent = 'Posted!';
        setTimeout(()=>{ Stories.__postBtn.textContent = 'Post'; Stories.__validate(); }, 900);
      }

      async function load(showSpinner){
        if(showSpinner) listBody.innerHTML = 'Loading‚Ä¶';
        let resp;
        if(viewingPen) resp = await dbFetchStoriesByPen(viewingPen);
        else resp = await dbFetchStories();
        const { data, error } = resp;
        if(error){ listBody.innerHTML = 'Could not load: ' + error.message; return; }
        items = data || [];
        renderList();
      }

      function renderList(){
        const ul = h('ul', {class:'list'});
        if(items.length === 0){
          ul.append(h('div',{class:'muted'}, viewingPen ? `No entries yet for ${viewingPen}.` : 'No entries yet. Be the first to post!'));
        } else {
          for(const it of items){
            const card = h('li',{class:'post', style:'margin-top:12px'});
            const header = h('div',{class:'row', style:'justify-content:space-between'},
              h('div',{},
                h('a',{href:'#stories?pen='+encodeURIComponent(it.pen), onclick:(e)=>{e.preventDefault(); viewingPen=it.pen; load(true);} , style:'color:#a5b4fc; font-weight:600; letter-spacing:.02em'}, esc(it.pen))
              ),
              h('time',{class:'muted'}, new Date(it.created_at).toLocaleString())
            );
            const body = h('div',{style:'margin-top:8px; white-space:pre-wrap'}, esc(it.text));

            const reactRow = h('div',{class:'row-wrap', style:'margin-top:10px'});
            const totalsEl = h('div',{class:'muted'});
            ALLOWED_EMOJIS.forEach(em=>{
              reactRow.append(h('span',{class:'pill', onclick:()=>toggleReact(it.id, em)}, em));
            });
            reactRow.append(totalsEl);

            const commentsWrap = h('div',{style:'margin-top:10px'});
            const commentInput = h('input',{placeholder:'Add a comment‚Ä¶'});
            const commentBtn = h('button',{class:'btn', onclick:()=>sendComment(it.id, commentInput)}, 'Comment');

            commentsWrap.append(
              h('div',{class:'row-wrap'}, commentInput, commentBtn),
              h('div',{id:'c-'+it.id, style:'margin-top:8px'})
            );

            card.append(header, body, reactRow, commentsWrap);
            ul.append(card);

            updateReactions(it.id, totalsEl);
            loadComments(it.id);
          }
        }
        listBody.innerHTML = '';
        if(viewingPen){
          listBody.append(
            h('div',{class:'row-wrap', style:'margin-bottom:8px'},
              h('span',{class:'muted'}, 'Viewing ' + viewingPen + ' ‚Äî '),
              h('button',{class:'btn', onclick:()=>{ viewingPen=null; load(true); }}, 'Back to all')
            )
          );
        }
        listBody.append(ul);
      }

      function isClientDuplicate(p, t){
        const clean = s => s.trim().replace(/\s+/g,' ');
        const now = Date.now();
        return items.some(e =>
          e.pen.trim() === clean(p) &&
          e.text.trim() === clean(t) &&
          (now - new Date(e.created_at).getTime()) < DUP_WINDOW_MS
        );
      }

      async function toggleReact(storyId, emoji){
        const pen = penInput.value.trim(); if(!pen){ alert('Set your Pen Name first'); return; }
        if(!ALLOWED_EMOJIS.includes(emoji)) return;
        await dbReact(storyId, pen, emoji);
        updateReactions(storyId, null);
      }
      async function updateReactions(storyId, target){
        const { totals } = await dbReactionTotals(storyId);
        const s = `Reactions: üëç ${totals["üëç"]||0} ¬∑ üòÇ ${totals["üòÇ"]||0} ¬∑ üî• ${totals["üî•"]||0} ¬∑ üëΩ ${totals["üëΩ"]||0}`;
        if(target) target.textContent = s;
      }

      async function sendComment(storyId, inputEl){
        const pen = penInput.value.trim(); if(!pen){ alert('Set your Pen Name first'); return; }
        const txt = inputEl.value.trim(); if(!txt) return;
        inputEl.disabled = true;
        try{
          await dbInsertComment(storyId, pen, txt);
          inputEl.value = '';
          loadComments(storyId);
        }catch(err){ alert('Could not comment: ' + (err?.message||err)); }
        inputEl.disabled = false;
      }
      async function loadComments(storyId){
        const { data, error } = await dbFetchComments(storyId);
        const target = document.getElementById('c-'+storyId);
        if(!target) return;
        if(error){ target.textContent = 'Could not load comments.'; return; }
        target.innerHTML = (data||[]).map(c =>
          `<div style="margin:6px 0"><b style="color:#c7d2fe">${esc(c.pen)}</b>: ${esc(c.text)} <small class="muted">(${new Date(c.created_at).toLocaleString()})</small></div>`
        ).join('');
      }

      // mount
      wrapper.append(idCard);
      wrapper.append(
        Card('Write a story','Shared across devices via Supabase',
          (()=>{
            const form = document.createElement('form');
            form.onsubmit = (e)=>{ e.preventDefault(); add(); };
            const text = document.createElement('textarea');
            text.placeholder = `Share a thought (max ${MAX_LEN} chars)‚Ä¶`;
            text.maxLength = MAX_LEN;
            const count = h('span',{class:'count'},'0/'+MAX_LEN);
            const postBtn = h('button',{class:'btn',type:'submit',disabled:true},'Post');
            const refreshBtn = h('button',{class:'btn',type:'button',onclick:()=>load(true)},'Refresh');

            function cooldownReady(){ const last=Number(localStorage.getItem('prism_last_post_at')||0); return Date.now()-last>=COOLDOWN_MS;}
            function validate(){ const ok=(penInput.value.trim().length>0 && text.value.trim().length>0 && cooldownReady()); postBtn.disabled=!ok; }
            text.addEventListener('input', ()=>{ count.textContent = text.value.length + '/' + MAX_LEN; validate(); });
            penInput.addEventListener('input', validate);

            form.append(
              h('div',{class:'grid',style:'grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px'}, text),
              h('div',{class:'row',style:'justify-content:space-between;margin-top:10px'}, count, h('div',{class:'row'}, postBtn, refreshBtn))
            );

            // expose to outer funcs
            Stories.__text = text; Stories.__postBtn = postBtn; Stories.__validate = validate; Stories.__add = add; Stories.__load = load;
            return form;
          })()
        )
      );
      const feed = Card('Community feed','Newest first ¬∑ click a pen name to see their archive', h('div', {}, 'Loading‚Ä¶'));
      wrapper.append(h('div',{style:'height:14px'}), feed);
      // rebind listBody
      const listBodyRef = () => feed.lastChild;
      // patch load to use latest listBody
      const _load = load;
      load = async (show)=>{ if(show) listBodyRef().innerHTML='Loading‚Ä¶'; await _load(false); };

      // initial fetch
      load(true);
      return wrapper;
    }

    // ---------- Home ----------
    function Home(){
      const grid = h('section',{class:'grid'});
      grid.append(
        Tile('Stories','#stories','Write and read entries from everyone (cloud synced).', (function(){const s=h('svg',{viewBox:'0 0 24 24',width:32,height:32});s.innerHTML='<path fill="#e2e8f0" d="M4 4h13a3 3 0 0 1 3 3v11.5a.5.5 0 0 1-.8.4L16 17H6a2 2 0 0 1-2-2V4z"/><path fill="#818cf8" d="M7 7h9v2H7zM7 11h9v2H7zM7 15h6v2H7z"/>';return s;})()),
        Tile('Fun','#fun','Playground of tiny toys. Eyeballs watch your cursor.', (function(){const s=h('svg',{viewBox:'0 0 24 24',width:32,height:32});s.innerHTML='<circle cx="12" cy="12" r="9" fill="#e2e8f0"/><circle cx="12" cy="12" r="4" fill="#6366f1"/>';return s;})())
      );
      const card = (function(){ const c = document.createElement('div'); return c; })();
      return h('div',{},grid);
    }

    // ---------- Fun (trimmed) ----------
    let trailOn = false;
    function spawnParticle(x,y){
      const p = document.createElement('div');
      p.className = 'particle';
      const ang = Math.random()*Math.PI*2, dist = 6+Math.random()*10;
      p.style.setProperty('--x', `${Math.cos(ang)*dist}px`);
      p.style.setProperty('--y', `${Math.sin(ang)*dist}px`);
      p.style.left = (x-4)+'px';
      p.style.top  = (y-4)+'px';
      const color = neon();
      p.style.background = color;
      p.style.boxShadow = `0 0 10px ${color}, 0 0 30px ${color}`;
      p.style.animation = 'pop 600ms ease-out forwards';
      document.body.appendChild(p);
      setTimeout(()=>p.remove(), 620);
    }
    function enableTrail(){ if(trailOn) return; trailOn = true; addEventListener('mousemove', trailMove, {passive:true}); addEventListener('touchmove', trailTouch, {passive:true}); }
    function disableTrail(){ trailOn = false; removeEventListener('mousemove', trailMove); removeEventListener('touchmove', trailTouch); }
    function trailMove(e){ spawnParticle(e.pageX,e.pageY); }
    function trailTouch(e){ const t=e.touches[0]; if(t) trailMove({pageX:t.pageX, pageY:t.pageY}); }

    function Fun(){
      let enabled = false;
      const btn = h('button',{class:'btn', onclick:()=>{
        enabled = !enabled;
        if(enabled){ enableTrail(); btn.textContent='Disable trail'; }
        else { disableTrail(); btn.textContent='Enable trail'; }
      }}, 'Enable trail');
      return h('div',{}, Card('Cursor Trail','Shiny sci-fi particles follow your cursor', h('div',{}, btn)));
    }

    // ---------- Router ----------
    function Tile(title,href,desc,icon){
      const a=h('a',{href,class:'tile'});
      const row=h('div',{style:'display:flex;gap:16px;align-items:flex-start'});
      const iconWrap=h('div',{style:'opacity:.85'}); iconWrap.append(icon);
      const text=h('div',{},
        h('div',{style:'font-weight:600;font-size:20px'},title),
        h('div',{class:'muted',style:'margin-top:6px'},desc),
        h('span',{style:'display:inline-block;margin-top:12px;color:#c7d2fe'},'Open ‚Üí')
      );
      row.append(iconWrap,text); a.append(row); return a;
    }
    function Card(title,subtitle,body,actions){
      const head=h('div',{style:'display:flex;justify-content:space-between;gap:12px;align-items:flex-start'});
      const left=h('div',{},h('div',{style:'font-weight:600;font-size:18px'},title),subtitle?h('div',{class:'muted',style:'margin-top:4px'},subtitle):null);
      head.append(left,actions||h('span'));
      const card=h('div',{class:'card'}); card.append(head,h('div',{style:'margin-top:14px'},body)); return card;
    }

    function route(){
      if(!location.hash) location.hash = '#home';
      const app = document.getElementById('app');
      app.innerHTML = '';
      const hash = location.hash;
      if(hash.startsWith('#stories')) app.append(Stories());
      else if(hash.startsWith('#fun')) app.append(Fun());
      else app.append(Home());
      setActiveNav();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    window.addEventListener('hashchange', route);
    route();
  </script>
</body>
</html>
