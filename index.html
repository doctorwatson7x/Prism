<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prism</title>
  <style>
    :root{ --bg1:#020617; --text:#e5e7eb; --muted:#94a3b8; --panel:rgba(255,255,255,0.04); --border:rgba(255,255,255,0.1); --brand:#6366f1; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:radial-gradient(circle at 10% 10%, #0a0f1f 0%, #000 60%) fixed;color:var(--text)}
    a{color:inherit;text-decoration:none}
    .container{max-width:1000px;margin:0 auto;padding:0 16px 80px}
    header{position:sticky;top:0;backdrop-filter:blur(8px);border-bottom:1px solid var(--border);background:rgba(255,255,255,0.02);z-index:10}
    header .row{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
    nav a{padding:8px 12px;border-radius:12px;color:#cbd5e1}
    nav a:hover,nav a.active{background:rgba(255,255,255,0.12);color:white}
    .card{border:1px solid var(--border);background:var(--panel);border-radius:20px;padding:24px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.06)}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .row{display:flex;gap:8px;align-items:center}
    .row-wrap{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    textarea,input,select{width:100%;background:rgba(0,0,0,0.4);border:1px solid rgba(255,255,255,0.15);color:var(--text);padding:10px 12px;border-radius:12px}
    textarea{min-height:90px;resize:vertical}
    .list{list-style:none;margin:0;padding:0}
    .post{border:1px solid var(--border);background:var(--panel);border-radius:14px;padding:16px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:rgba(0,0,0,.25);cursor:pointer}
    .pill:hover{background:rgba(255,255,255,0.06)}
    .muted{color:var(--muted)}
    .count{font-size:12px;color:#a5b4fc}
    /* Eyes */
    .eyeShell{height:220px;display:grid;place-items:center}
    .eyes{display:flex;gap:24px}
    .eye{position:relative;height:110px;width:110px;border-radius:50%;background:rgba(255,255,255,0.9);border:1px solid rgba(255,255,255,0.3);box-shadow: inset 0 8px 30px rgba(0,0,0,.35), 0 2px 30px rgba(99,102,241,.35);overflow:hidden}
    .eye::before{content:"";position:absolute;inset:0;background:radial-gradient(circle at 50% 30%, rgba(226,232,240,.9), rgba(203,213,225,.8), transparent 70%)}
    .pupil{position:absolute;top:50%;left:50%;height:36px;width:36px;background:#1e1b4b;border-radius:50%;transform:translate(-50%,-50%)}
    .pupil::after{content:"";position:absolute;inset:4px;background:var(--brand);border-radius:50%}
    /* cursor particles */
    .particle{position:fixed;width:8px;height:8px;border-radius:50%;pointer-events:none;will-change:transform,opacity;filter:blur(0.2px)}
    @keyframes pop{from{transform:translate(var(--x),var(--y)) scale(1);opacity:1}to{transform:translate(calc(var(--x)*2),calc(var(--y)*2)) scale(0);opacity:0}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <header>
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <svg width="28" height="28" viewBox="0 0 64 64" aria-hidden>
            <polygon points="32,6 58,54 6,54" fill="none" stroke="#818cf8" stroke-width="2"></polygon>
            <line x1="0" y1="22" x2="28" y2="28" stroke="#cbd5e1" stroke-width="2"></line>
            <line x1="36" y1="30" x2="64" y2="18" stroke="#fb7185" stroke-width="2"></line>
            <line x1="36" y1="32" x2="64" y2="32" stroke="#34d399" stroke-width="2"></line>
            <line x1="36" y1="34" x2="64" y2="46" stroke="#22d3ee" stroke-width="2"></line>
          </svg>
          <strong>Prism</strong>
        </div>
        <nav>
          <a href="#home" id="navHome">Home</a>
          <a href="#stories" id="navStories">Stories</a>
          <a href="#fun" id="navFun">Fun</a>
        </nav>
      </div>
    </header>

    <main id="app" style="padding-top:24px"></main>

    <footer class="row" style="justify-content:space-between;margin-top:24px">
      <div class="muted">Â© <span id="year"></span> Prism</div>
      <div class="muted">Alien-sleek starter</div>
    </footer>
  </div>

  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://niynqtpppdzrciozjcvr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5peW5xdHBwcGR6cmNpb3pqY3ZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MTAyODcsImV4cCI6MjA3MjA4NjI4N30.lnlXM9lzfdOaCW6UQ5fBZ_SHd8TOVF0KCgpSsTrMbgs";
    document.getElementById('year').textContent = new Date().getFullYear();
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== helpers ======
    function h(tag, attrs={}, ...children){
      const el = document.createElement(tag);
      for(const k in attrs){
        if(k.startsWith('on') && typeof attrs[k]==='function'){ el.addEventListener(k.slice(2).toLowerCase(), attrs[k]); }
        else if(k==='html'){ el.innerHTML = attrs[k]; }
        else { el.setAttribute(k, attrs[k]); }
      }
      for(const c of children){ if(c==null) continue; el.append(c.nodeType ? c : document.createTextNode(c)); }
      return el;
    }
    // Escape ONLY < and > so & and " stay literal
    const esc = (s)=> String(s ?? '').replace(/[<>]/g, m => ({'<':'&lt;','>':'&gt;'}[m]));
    const choose = (arr)=>arr[Math.floor(Math.random()*arr.length)];
    function setActiveNav(){
      const hash = location.hash || '#home';
      document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));
      if(hash.startsWith('#stories')) document.getElementById('navStories').classList.add('active');
      else if(hash.startsWith('#fun')) document.getElementById('navFun').classList.add('active');
      else document.getElementById('navHome').classList.add('active');
    }
    function Card(title, subtitle, body){
      const head = h('div',{style:'display:flex;justify-content:space-between;gap:12px;align-items:flex-start'},
        h('div',{}, h('div',{style:'font-weight:600;font-size:18px'}, title), subtitle? h('div',{class:'muted',style:'margin-top:4px'}, subtitle):null)
      );
      const card = h('div',{class:'card'}); card.append(head, h('div',{style:'margin-top:14px'}, body)); return card;
    }
    const neon = () => {
      const hueBands = [[200,260],[160,190],[300,330],[180,200]];
      const [a,b] = choose(hueBands);
      const h = Math.floor(a + Math.random()*(b-a));
      return `hsla(${h} 95% 65% / 1)`;
    };

    // ====== DB ops ======
    const ALLOWED_EMOJIS = ["ðŸ‘","ðŸ˜‚","ðŸ”¥","ðŸ‘½"];
    async function dbFetchStories(){ return await supabase.from('stories').select('id, pen, text, created_at').order('created_at',{ascending:false}).limit(200); }
    async function dbFetchStoriesByPen(pen){ return await supabase.from('stories').select('id, pen, text, created_at').eq('pen', pen).order('created_at',{ascending:false}).limit(200); }
    async function dbInsertStory(pen, text){ return await supabase.from('stories').insert([{ pen, text }]).select(); }
    async function dbInsertComment(story_id, pen, text){ return await supabase.from('comments').insert([{ story_id, pen, text }]).select(); }
    async function dbFetchComments(story_id){ return await supabase.from('comments').select('id, story_id, pen, text, created_at').eq('story_id', story_id).order('created_at',{ascending:true}); }
    async function dbReact(story_id, pen, emoji){ await supabase.from('reactions').delete().match({ story_id, pen, emoji }); return await supabase.from('reactions').insert([{ story_id, pen, emoji }]).select(); }
    async function dbReactionTotals(story_id){
      const { data, error } = await supabase.from('reactions').select('emoji, count:emoji', { count:'exact', head:false }).eq('story_id', story_id);
      if(error) return { totals:{} };
      const totals = { "ðŸ‘":0,"ðŸ˜‚":0,"ðŸ”¥":0,"ðŸ‘½":0 };
      (data||[]).forEach(r=>{ if(ALLOWED_EMOJIS.includes(r.emoji)) totals[r.emoji]=(totals[r.emoji]||0)+1; });
      return { totals };
    }

    // ====== Identity (with mask preview) ======
    const LAST_PEN_KEY='prism_last_pen';
    const LAST_MASK_KEY='prism_last_mask';
    const LAST_RESERVED='prism_reserved';
    const MASKS = ["Grey","Reptilian","Nordic","Insectoid","Cyborg Alien","Retro Martian","Roswell Cartoon","Xeno-Beast","Space Wizard","Cosmic Jellyfish","Nebula Face","Crystal Skull","Obsidian Fox","Solar Phantom","Void Wraith"];
    function maskSVG(type){
      const svg = (inner)=>{ const s = h('svg',{viewBox:'0 0 64 64',width:56,height:56, style:'filter:drop-shadow(0 0 6px rgba(99,102,241,.6))'}); s.innerHTML = inner; return s; };
      const glow = '#7c83ff', line = '#bcd3ff';
      switch(type){
        case 'Grey': return svg(`<ellipse cx="32" cy="36" rx="18" ry="22" fill="none" stroke="${glow}" stroke-width="2"/><ellipse cx="24" cy="36" rx="6" ry="8" fill="${line}"/><ellipse cx="40" cy="36" rx="6" ry="8" fill="${line}"/>`);
        case 'Reptilian': return svg(`<path d="M12 40 Q32 10 52 40 Q32 58 12 40Z" fill="none" stroke="${glow}" stroke-width="2"/><path d="M22 36 Q26 32 30 36" stroke="${line}" stroke-width="3"/><path d="M34 36 Q38 32 42 36" stroke="${line}" stroke-width="3"/>`);
        case 'Nordic': return svg(`<circle cx="32" cy="32" r="18" fill="none" stroke="${glow}" stroke-width="2"/><circle cx="26" cy="30" r="3" fill="${line}"/><circle cx="38" cy="30" r="3" fill="${line}"/>`);
        case 'Insectoid': return svg(`<ellipse cx="32" cy="34" rx="20" ry="16" fill="none" stroke="${glow}" stroke-width="2"/><ellipse cx="24" cy="34" rx="7" ry="9" fill="${line}"/><ellipse cx="40" cy="34" rx="7" ry="9" fill="${line}"/>`);
        case 'Cyborg Alien': return svg(`<rect x="16" y="16" width="32" height="32" rx="10" fill="none" stroke="${glow}" stroke-width="2"/><circle cx="26" cy="32" r="5" fill="${line}"/><rect x="34" y="28" width="12" height="8" fill="${line}"/>`);
        case 'Retro Martian': return svg(`<circle cx="32" cy="34" r="16" fill="none" stroke="${glow}" stroke-width="2"/><line x1="28" y1="18" x2="24" y2="10" stroke="${line}" stroke-width="2"/><line x1="36" y1="18" x2="40" y2="10" stroke="${line}" stroke-width="2"/>`);
        case 'Roswell Cartoon': return svg(`<ellipse cx="32" cy="34" rx="16" ry="18" fill="none" stroke="${glow}" stroke-width="2"/><circle cx="26" cy="34" r="5" fill="${line}"/><circle cx="38" cy="34" r="5" fill="${line}"/>`);
        case 'Xeno-Beast': return svg(`<path d="M16 46 Q32 10 48 46" fill="none" stroke="${glow}" stroke-width="2"/><path d="M22 34 L28 36" stroke="${line}" stroke-width="3"/><path d="M42 34 L36 36" stroke="${line}" stroke-width="3"/>`);
        case 'Space Wizard': return svg(`<path d="M12 28 L32 8 L52 28 V52 H12Z" fill="none" stroke="${glow}" stroke-width="2"/><circle cx="32" cy="36" r="4" fill="${line}"/>`);
        case 'Cosmic Jellyfish': return svg(`<circle cx="32" cy="28" r="12" fill="none" stroke="${glow}" stroke-width="2"/><path d="M20 40 Q24 48 28 40 Q32 48 36 40 Q40 48 44 40" stroke="${line}" stroke-width="2" fill="none"/>`);
        case 'Nebula Face': return svg(`<circle cx="32" cy="32" r="18" fill="none" stroke="${glow}" stroke-width="2"/><circle cx="26" cy="30" r="2" fill="${line}"/><circle cx="38" cy="34" r="2" fill="${line}"/>`);
        case 'Crystal Skull': return svg(`<path d="M20 18 H44 V40 L32 50 L20 40 Z" fill="none" stroke="${glow}" stroke-width="2"/><line x1="20" y1="28" x2="44" y2="28" stroke="${line}" stroke-width="2"/>`);
        case 'Obsidian Fox': return svg(`<path d="M16 28 L24 16 L32 26 L40 16 L48 28 V48 H16Z" fill="none" stroke="${glow}" stroke-width="2"/><circle cx="26" cy="34" r="3" fill="${line}"/><circle cx="38" cy="34" r="3" fill="${line}"/>`);
        case 'Solar Phantom': return svg(`<circle cx="32" cy="32" r="16" fill="none" stroke="${glow}" stroke-width="2"/><path d="M16 32 A16 16 0 0 0 48 32" stroke="${line}" stroke-width="2" fill="none"/>`);
        case 'Void Wraith': return svg(`<path d="M16 20 Q32 10 48 20 V48 H16Z" fill="none" stroke="${glow}" stroke-width="2"/><circle cx="28" cy="30" r="2" fill="${line}"/><circle cx="36" cy="30" r="2" fill="${line}"/>`);
        default: return svg(`<circle cx="32" cy="32" r="18" fill="none" stroke="${glow}" stroke-width="2"/>`);
      }
    }

    // ====== Pages ======
    function Home(){
      const grid = h('section',{class:'grid'});
      grid.append(
        Card('Stories','Write and read entries (cloud synced)', h('div',{}, h('a',{href:'#stories', style:'color:#c7d2fe'}, 'Go to Stories â†’'))),
        Card('Fun','Tiny toys', h('div',{}, h('a',{href:'#fun', style:'color:#c7d2fe'}, 'Go to Fun â†’')))
      );
      return h('div',{}, grid);
    }

    function Stories(){
      const wrapper = h('div',{}); let items=[]; let viewingPen=null;

      // Identity
      const penInput = h('input',{placeholder:'Pen name', maxlength:'40', value:localStorage.getItem(LAST_PEN_KEY)||''});
      const maskSel  = h('select',{}, ...MASKS.map(m=>h('option',{value:m,selected:(localStorage.getItem(LAST_MASK_KEY)||'Grey')===m}, m)));
      const maskRow  = h('div',{class:'row',style:'gap:12px;align-items:center;margin-top:6px'});
      function renderMask(){ maskRow.innerHTML=''; maskRow.append(maskSVG(maskSel.value), h('div',{class:'muted'}, maskSel.value)); }
      renderMask(); maskSel.addEventListener('input', renderMask);

      const pw = h('input',{type:'password', placeholder:'Password (optional to reserve pen)'});
      async function reserve(){
        const p = penInput.value.trim(); if(!p) return alert('Enter a pen name');
        const password = pw.value.trim() || null;
        const enc = (s)=>crypto.subtle.digest('SHA-256', new TextEncoder().encode(s)).then(b=>Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join(''));
        const password_hash = password ? await enc(password) : null;
        const { error } = await supabase.from('users').upsert([{ pen:p, mask:maskSel.value, password_hash }], { onConflict:'pen' });
        if(error) return alert('Could not reserve: '+error.message);
        localStorage.setItem(LAST_PEN_KEY,p); localStorage.setItem(LAST_MASK_KEY,maskSel.value);
        alert(password ? 'Reserved! ðŸ”’' : 'Saved (guest)');
      }
      const idCard = Card('Identity','Password optional â€” use it to reserve your pen name.',
        h('div',{},
          h('div',{class:'grid',style:'grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px'}, penInput, maskSel, pw),
          maskRow,
          h('div',{class:'row',style:'margin-top:8px'}, h('button',{class:'pill',onclick:reserve},'Save / Reserve'))
        )
      );

      // Composer
      const text = h('textarea',{placeholder:'Share a thoughtâ€¦ (max 2000 chars)', maxlength:2000});
      const count= h('span',{class:'count'},'0/2000');
      const postBtn=h('button',{class:'pill',onclick:add,disabled:true},'Post');
      const refreshBtn=h('button',{class:'pill',onclick:()=>load(true)},'Refresh');

      function cooldownReady(){ const last=Number(localStorage.getItem('prism_last_post_at')||0); return Date.now()-last>=10000; }
      function validate(){ postBtn.disabled = !(penInput.value.trim() && text.value.trim() && cooldownReady()); }
      text.addEventListener('input',()=>{count.textContent=text.value.length+'/2000'; validate();});
      penInput.addEventListener('input', validate);

      const composeCard = Card('Write a story','', h('div',{},
        h('div',{class:'grid',style:'grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px'}, text),
        h('div',{class:'row',style:'justify-content:space-between;margin-top:10px'}, count, h('div',{class:'row'}, postBtn, refreshBtn))
      ));

      // Feed
      const feedCard = Card('Community feed','Newest first Â· click a pen to filter', h('div',{},'Loadingâ€¦'));
      const listBody = feedCard.lastChild;

      function isDup(p,t){ const clean=s=>s.trim().replace(/\s+/g,' '); const now=Date.now(); return items.some(e=> e.pen.trim()===clean(p) && e.text.trim()===clean(t) && (now-new Date(e.created_at).getTime())<120000); }

      async function add(){
        if(!cooldownReady()) return alert('Cooling down a few secondsâ€¦');
        const p=penInput.value.trim(), t=text.value.trim(); if(!p||!t) return;
        if(isDup(p,t)) return alert('Looks like you just posted that.');
        postBtn.textContent='Postingâ€¦'; postBtn.disabled=true;
        const { error } = await dbInsertStory(p,t);
        if(error){ alert('Could not post: '+error.message); postBtn.textContent='Post'; validate(); return; }
        localStorage.setItem('prism_last_post_at', String(Date.now()));
        localStorage.setItem(LAST_PEN_KEY,p); localStorage.setItem(LAST_MASK_KEY,maskSel.value);
        text.value=''; count.textContent='0/2000';
        await load(true);
        postBtn.textContent='Post'; validate();
      }

      async function load(spinner){
        if(spinner) listBody.innerHTML='Loadingâ€¦';
        const resp = viewingPen ? await dbFetchStoriesByPen(viewingPen) : await dbFetchStories();
        if(resp.error){ listBody.textContent='Could not load: '+resp.error.message; return; }
        items = resp.data||[]; renderList();
      }

      function renderList(){
        const ul = h('ul',{class:'list'});
        if(items.length===0){ ul.append(h('div',{class:'muted'}, viewingPen?`No entries yet for ${viewingPen}.`:'No entries yet.')); }
        items.forEach(it=>{
          const li = h('li',{class:'post',style:'margin-top:12px'});

          // header
          const header = h('div',{class:'row',style:'justify-content:space-between'},
            h('div',{}, h('a',{href:'#stories',onclick:(e)=>{e.preventDefault(); viewingPen=it.pen; load(true);},style:'color:#a5b4fc;font-weight:600'}, esc(it.pen))),
            h('time',{class:'muted'}, new Date(it.created_at).toLocaleString())
          );

          // body
          const body = h('div',{style:'margin-top:8px; white-space:pre-wrap'}, esc(it.text));

          // reactions (instant update)
          const reactRow = h('div',{class:'row-wrap',style:'margin-top:10px'});
          const totalsEl = h('div',{class:'muted'});
          ALLOWED_EMOJIS.forEach(em=>{
            reactRow.append(h('span',{class:'pill',onclick:()=>toggleReact(it.id, em, totalsEl)}, em));
          });
          reactRow.append(totalsEl);

          // comments
          const commentsWrap = h('div',{style:'margin-top:10px'});
          const commentInput = h('input',{placeholder:'Add a commentâ€¦'});
          const commentBtn = h('button',{class:'pill',onclick:()=>sendComment(it.id, commentInput)},'Comment');
          const commentsList = h('div',{id:'c-'+it.id,style:'margin-top:8px'});
          commentsWrap.append(h('div',{class:'row-wrap'}, commentInput, commentBtn), commentsList);

          li.append(header, body, reactRow, commentsWrap);
          ul.append(li);

          updateReactions(it.id, totalsEl);
          loadComments(it.id, commentsList);
        });

        listBody.innerHTML='';
        if(viewingPen){
          listBody.append(
            h('div',{class:'row-wrap',style:'margin-bottom:8px'},
              h('span',{class:'muted'},'Viewing '+viewingPen+' â€” '),
              h('button',{class:'pill',onclick:()=>{viewingPen=null; load(true);}},'Back to all')
            )
          );
        }
        listBody.append(ul);
      }

      async function toggleReact(storyId, emoji, totalsEl){
        const pen = penInput.value.trim(); if(!pen) return alert('Set your Pen Name first');
        if(totalsEl) totalsEl.textContent = 'Updatingâ€¦';
        await dbReact(storyId, pen, emoji);
        await updateReactions(storyId, totalsEl);
      }
      async function updateReactions(storyId, target){
        const { totals } = await dbReactionTotals(storyId);
        const s = `Reactions: ðŸ‘ ${totals["ðŸ‘"]||0} Â· ðŸ˜‚ ${totals["ðŸ˜‚"]||0} Â· ðŸ”¥ ${totals["ðŸ”¥"]||0} Â· ðŸ‘½ ${totals["ðŸ‘½"]||0}`;
        if(target) target.textContent = s;
      }
      async function sendComment(storyId, inputEl){
        const pen = penInput.value.trim(); if(!pen) return alert('Set your Pen Name first');
        const txt = inputEl.value.trim(); if(!txt) return;
        inputEl.disabled=true;
        const { error } = await dbInsertComment(storyId, pen, txt);
        if(!error){ inputEl.value=''; loadComments(storyId, document.getElementById('c-'+storyId)); }
        inputEl.disabled=false;
      }
      async function loadComments(storyId, target){
        const { data, error } = await dbFetchComments(storyId);
        if(error){ target.textContent='Could not load comments.'; return; }
        target.innerHTML = (data||[]).map(c => `<div style="margin:6px 0"><b style="color:#c7d2fe">${esc(c.pen)}</b>: ${esc(c.text)} <small class="muted">(${new Date(c.created_at).toLocaleString()})</small></div>`).join('');
      }

      wrapper.append(idCard, h('div',{style:'height:10px'}), composeCard, h('div',{style:'height:14px'}), feedCard);
      load(true);
      return wrapper;
    }

    // Fun toys restored
    function Fun(){
      // Eyes
      const eyesWrap = h('div',{class:'eyeShell'}), eyes = h('div',{class:'eyes'});
      function makeEye(){ const eye = h('div',{class:'eye'}), pupil=h('div',{class:'pupil'}); eye.append(pupil); return {eye,pupil}; }
      const e1=makeEye(), e2=makeEye(); eyes.append(e1.eye, e2.eye); eyesWrap.append(eyes);
      let centers=[];
      function measure(){ centers = [e1.eye,e2.eye].map(el=>{ const r=el.getBoundingClientRect(); return {x:r.left+r.width/2+scrollX,y:r.top+r.height/2+scrollY};}); }
      addEventListener('resize', measure); setTimeout(measure,60);
      function moveEyes(x,y){ if(centers.length<2) measure(); [e1,e2].forEach((E,i)=>{ const c=centers[i]; const dx=x-c.x, dy=y-c.y, ang=Math.atan2(dy,dx), max=10; E.pupil.style.transform=`translate(calc(-50% + ${Math.cos(ang)*max}px), calc(-50% + ${Math.sin(ang)*max}px))`; }); }
      addEventListener('mousemove',(e)=>moveEyes(e.pageX,e.pageY),{passive:true});
      addEventListener('touchmove',(e)=>{const t=e.touches[0]; if(t) moveEyes(t.pageX,t.pageY);},{passive:true});

      // Cursor trail toggle
      let trailOn=false;
      function spawnParticle(x,y){
        const p=document.createElement('div'); p.className='particle';
        const ang=Math.random()*Math.PI*2, dist=6+Math.random()*10;
        p.style.setProperty('--x',`${Math.cos(ang)*dist}px`); p.style.setProperty('--y',`${Math.sin(ang)*dist}px`);
        p.style.left=(x-4)+'px'; p.style.top=(y-4)+'px';
        const color=neon(); p.style.background=color; p.style.boxShadow=`0 0 10px ${color}, 0 0 30px ${color}`; p.style.animation='pop 600ms ease-out forwards';
        document.body.appendChild(p); setTimeout(()=>p.remove(),620);
      }
      function enableTrail(){ if(trailOn) return; trailOn=true; addEventListener('mousemove', trailMove, {passive:true}); addEventListener('touchmove', trailTouch, {passive:true}); }
      function disableTrail(){ trailOn=false; removeEventListener('mousemove', trailMove); removeEventListener('touchmove', trailTouch); }
      function trailMove(e){ spawnParticle(e.pageX,e.pageY); }
      function trailTouch(e){ const t=e.touches[0]; if(t) trailMove({pageX:t.pageX,pageY:t.pageY}); }
      const trailBtn=h('button',{class:'pill',onclick:()=>{ if(trailOn){ disableTrail(); trailBtn.textContent='Enable trail'; } else { enableTrail(); trailBtn.textContent='Disable trail'; } }},'Enable trail');

      // Quotes
      const QUOTES = {
        jokes:[
          "I told my computer I needed a breakâ€”it said it was going to sleep anyway.",
          "There are 10 types of people: those who understand binary and those who donâ€™t.",
          "My code doesnâ€™t have bugs; it just develops random features."
        ],
        scifi:[
          "â€œDo. Or do not. There is no try.â€ â€” Yoda",
          "â€œIâ€™m sorry, Dave. Iâ€™m afraid I canâ€™t do that.â€ â€” HAL 9000",
          "â€œThe cosmos is within us. We are made of star-stuff.â€ â€” Carl Sagan"
        ],
        fortune:[
          "A new idea will transport you to unexpected places.",
          "Your curiosity will open a door you didnâ€™t know existed.",
          "Good news will arrive from a great distance."
        ],
        philosophy:[
          "â€œThe unexamined life is not worth living.â€ â€” Socrates",
          "â€œWe are what we repeatedly do.â€ â€” Aristotle",
          "â€œMan is condemned to be free.â€ â€” Sartre"
        ]
      };
      const select = h('select',{}, ...['jokes','scifi','fortune','philosophy','surprise'].map(k=>h('option',{value:k},k)));
      const out = h('div',{class:'card',style:'margin-top:10px;padding:12px;font-size:15px'}, 'Click â€œGenerateâ€.');
      const gen = h('button',{class:'pill',onclick:()=>{ const cat=select.value; const pool=(cat==='surprise')?[...QUOTES.jokes,...QUOTES.scifi,...QUOTES.fortune,...QUOTES.philosophy]:QUOTES[cat]; out.textContent=choose(pool); }},'Generate');

      // Blob
      const blob = h('div',{style:'width:160px;height:160px;border-radius:50%;background:radial-gradient(circle at 40% 35%,rgba(255,255,255,.5),rgba(99,102,241,.6) 35%,rgba(2,6,23,.9) 70%);border:1px solid rgba(255,255,255,.25);box-shadow:inset 0 20px 60px rgba(0,0,0,.45), 0 10px 50px rgba(99,102,241,.35)'});
      const colorSel = h('select',{},...['indigo','pink','green','cyan'].map(c=>h('option',{value:c},c)));
      const sizeSel = h('input',{type:'range',min:'120',max:'220',value:'160'});
      function setBlobColor(v){ const m={indigo:'rgba(99,102,241,.6)',pink:'rgba(236,72,153,.6)',green:'rgba(34,197,94,.6)',cyan:'rgba(34,211,238,.6)'}[v]||'rgba(99,102,241,.6)'; blob.style.background=`radial-gradient(circle at 40% 35%,rgba(255,255,255,.5),${m} 35%,rgba(2,6,23,.9) 70%)`; blob.style.boxShadow=`inset 0 20px 60px rgba(0,0,0,.45), 0 10px 50px ${m}`; }
      colorSel.oninput=(e)=>setBlobColor(e.target.value);
      sizeSel.oninput=(e)=>{ blob.style.width=blob.style.height=e.target.value+'px'; };
      setBlobColor('indigo');

      return h('div',{},
        Card('The Eyes','They follow your cursorâ€¦', eyesWrap),
        h('div',{style:'height:14px'}),
        Card('Cursor Trail','Toggle neon particles following your cursor', h('div',{}, trailBtn)),
        h('div',{style:'height:14px'}),
        Card('Random Quote','Jokes, sci-fi, fortunes, philosophy',
          h('div',{}, h('div',{}, select), h('div',{style:'margin-top:10px'}, gen), out)
        ),
        h('div',{style:'height:14px'}),
        Card('Pet Blob','Customize color & size',
          h('div',{style:'display:grid;place-items:center;gap:12px'}, blob, h('div',{class:'row-wrap'}, h('label',{},'Color: ',colorSel), h('label',{},'Size: ',sizeSel)))
        )
      );
    }

    // ====== Router ======
    function route(){
      if(!location.hash) location.hash = '#home';
      const app = document.getElementById('app'); app.innerHTML='';
      const hash = location.hash;
      if(hash.startsWith('#stories')) app.append(Stories());
      else if(hash.startsWith('#fun')) app.append(Fun());
      else app.append(Home());
      setActiveNav();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    window.addEventListener('hashchange', route);
    window.addEventListener('DOMContentLoaded', route);
    route();
  </script>
</body>
</html>
