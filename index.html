<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prism</title>
  <style>
    :root{
      --bg1:#020617; --bg2:#0b1220; --text:#e5e7eb; --muted:#94a3b8;
      --ink:#a5b4fc; --indigo:#6366f1; --panel:rgba(255,255,255,0.04);
      --border:rgba(255,255,255,0.1); --danger:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{margin:0; height:100%; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; background: radial-gradient(circle at 10% 10%, #0a0f1f 0%, #000 60%) fixed; color:var(--text)}
    a{color:inherit; text-decoration:none}
    .container{max-width:1000px; margin:0 auto; padding:0 16px 80px}
    header{position:sticky; top:0; backdrop-filter: blur(8px); border-bottom:1px solid var(--border); background:rgba(255,255,255,0.02); z-index:10}
    header .row{display:flex; align-items:center; justify-content:space-between; padding:12px 0}
    nav a{padding:8px 12px; border-radius:12px; color:#cbd5e1}
    nav a:hover{background:rgba(255,255,255,0.08); color:white}
    nav a.active{background:rgba(255,255,255,0.12); color:white; outline:1px solid rgba(255,255,255,0.08)}
    .logo{display:flex; align-items:center; gap:8px}
    .grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .tile{position:relative; overflow:hidden; border:1px solid var(--border); background:var(--panel); border-radius:20px; padding:24px; transition:.2s}
    .tile:hover{background:rgba(255,255,255,0.08)}
    .card{border:1px solid var(--border); background:var(--panel); border-radius:20px; padding:24px; box-shadow:inset 0 1px 0 rgba(255,255,255,0.06)}
    .muted{color:var(--muted)}
    .btn{display:inline-block; background:#4f46e5; color:white; padding:10px 14px; border-radius:12px; border:0; cursor:pointer}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .btn:hover{background:#6366f1}
    .btn-danger{background:var(--danger)}
    .btn-danger:hover{background:#ef4444}
    footer{margin-top:32px; display:flex; justify-content:space-between; color:#94a3b8; font-size:14px}
    .stars::before{content:""; position:fixed; inset:0; background-image:radial-gradient(rgba(99,102,241,0.08) 1px, transparent 1px); background-size:24px 24px; opacity:.4; pointer-events:none}
    textarea,input{width:100%; background:rgba(0,0,0,0.4); border:1px solid rgba(255,255,255,0.15); color:var(--text); padding:10px 12px; border-radius:12px}
    textarea{min-height:90px; resize:vertical}
    .list{list-style:none; margin:0; padding:0}
    .post{border:1px solid var(--border); background:var(--panel); border-radius:14px; padding:16px}
    .eyeShell{height:220px; display:grid; place-items:center}
    .eyes{display:flex; gap:24px}
    .eye{position:relative; height:110px; width:110px; border-radius:50%; background:rgba(255,255,255,0.9); border:1px solid rgba(255,255,255,0.3); box-shadow: inset 0 8px 30px rgba(0,0,0,.35), 0 2px 30px rgba(99,102,241,.35); overflow:hidden}
    .eye::before{content:""; position:absolute; inset:0; background:radial-gradient(circle at 50% 30%, rgba(226,232,240,.9), rgba(203,213,225,.8), transparent 70%)}
    .pupil{position:absolute; top:50%; left:50%; height:36px; width:36px; background:#1e1b4b; border-radius:50%; transform:translate(-50%,-50%);}
    .pupil::after{content:""; position:absolute; inset:4px; background:#4f46e5; border-radius:50%}
    .glint{position:absolute; top:6px; left:12px; height:10px; width:10px; border-radius:50%; background:rgba(255,255,255,0.9)}
    .pulse{height:48px; border:1px solid rgba(99,102,241,.35); border-radius:12px}
    .row-end{display:flex; gap:8px; align-items:center}
    .count{font-size:12px; color:#a5b4fc}
    .toast{position:fixed; left:50%; bottom:22px; transform:translateX(-50%); background:rgba(16,185,129,0.15); border:1px solid rgba(16,185,129,0.35); color:#d1fae5; padding:10px 14px; border-radius:12px; box-shadow:0 6px 30px rgba(16,185,129,0.25); z-index:50}
    .spin{display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,.35); border-top-color:white; border-radius:50%; animation:rot 0.8s linear infinite; vertical-align:-3px}
    @keyframes rot{to{transform:rotate(360deg)}}
  </style>
  <!-- Supabase client via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="stars">
  <div class="container">
    <header>
      <div class="row">
        <div class="logo">
          <svg width="28" height="28" viewBox="0 0 64 64" aria-hidden>
            <polygon points="32,6 58,54 6,54" fill="none" stroke="#818cf8" stroke-width="2"></polygon>
            <line x1="0" y1="22" x2="28" y2="28" stroke="#cbd5e1" stroke-width="2"></line>
            <line x1="36" y1="30" x2="64" y2="18" stroke="#fb7185" stroke-width="2"></line>
            <line x1="36" y1="32" x2="64" y2="32" stroke="#34d399" stroke-width="2"></line>
            <line x1="36" y1="34" x2="64" y2="46" stroke="#22d3ee" stroke-width="2"></line>
          </svg>
          <div style="font-weight:600; letter-spacing:.08em; font-size:20px">Prism</div>
        </div>
        <nav>
          <a href="#home" id="navHome">Home</a>
          <a href="#stories" id="navStories">Stories</a>
          <a href="#fun" id="navFun">Fun</a>
        </nav>
      </div>
    </header>

    <main id="app" style="padding-top:24px"></main>

    <footer>
      <div>© <span id="year"></span> Prism. Forged in the void.</div>
      <div class="muted">Alien-sleek starter · Free deploy</div>
    </footer>
  </div>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // ====== CONFIG: paste your values here ======
    const SUPABASE_URL = "https://niynqtpppdzrciozjcvr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5peW5xdHBwcGR6cmNpb3pqY3ZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1MTAyODcsImV4cCI6MjA3MjA4NjI4N30.lnlXM9lzfdOaCW6UQ5fBZ_SHd8TOVF0KCgpSsTrMbgs";  // from Settings → API
    // ============================================

    // globals
    let supabase = null;
    const STORAGE_KEY='prism_stories_v1';     // still used for local delete reloads
    const LAST_PEN_KEY='prism_last_pen';
    const LAST_POST_AT='prism_last_post_at';
    const MAX_LEN = 2000;
    const COOLDOWN_MS = 10_000;    // 10s
    const DUP_WINDOW_MS = 120_000; // client-side duplicate window

    // helpers
    function h(tag, attrs={}, ...children){
      const el = document.createElement(tag);
      for(const k in attrs){
        if(k.startsWith('on') && typeof attrs[k]==='function'){ el.addEventListener(k.slice(2).toLowerCase(), attrs[k]); }
        else if(k==='html'){ el.innerHTML = attrs[k]; }
        else { el.setAttribute(k, attrs[k]); }
      }
      for(const c of children){ if(c==null) continue; el.append(c.nodeType ? c : document.createTextNode(c)); }
      return el;
    }
    const esc = (s) => s.replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
    function toast(msg){ const t = h('div',{class:'toast'}, msg); document.body.appendChild(t); setTimeout(()=>t.remove(),1600); }
    function setActiveNav(){
      const hash = location.hash || '#home';
      document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
      if(hash.startsWith('#stories')) document.getElementById('navStories').classList.add('active');
      else if(hash.startsWith('#fun')) document.getElementById('navFun').classList.add('active');
      else document.getElementById('navHome').classList.add('active');
    }

    // Supabase init
    function initSupabase(){
      if(!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes("YOUR_SUPABASE")){
        console.warn("Supabase keys missing—Stories will not load.");
        return null;
      }
      return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
    supabase = initSupabase();

    // UI building blocks
    function Card(title, subtitle, body, actions){
      const head = h('div', {style:'display:flex; justify-content:space-between; gap:12px; align-items:flex-start'});
      const left = h('div',{},
        h('div',{style:'font-weight:600; font-size:18px'}, title),
        subtitle ? h('div',{class:'muted', style:'margin-top:4px'}, subtitle) : null
      );
      head.append(left, actions||h('span'));
      const card = h('div',{class:'card'});
      card.append(head, h('div',{style:'margin-top:14px'}, body));
      return card;
    }
    function Tile(title, href, desc, icon){
      const a = h('a', {href, class:'tile'});
      const row = h('div', {style:'display:flex; gap:16px; align-items:flex-start'});
      const iconWrap = h('div', {style:'opacity:.85'}); iconWrap.append(icon);
      const text = h('div', {},
        h('div', {style:'font-weight:600; font-size:20px'}, title),
        h('div', {class:'muted', style:'margin-top:6px'}, desc),
        h('span', {style:'display:inline-block; margin-top:12px; color:#c7d2fe'}, 'Open →')
      );
      row.append(iconWrap, text); a.append(row); return a;
    }
    function IconDoc(){ const s = h('svg',{viewBox:'0 0 24 24', width:32, height:32}); s.innerHTML = '<path fill="#e2e8f0" d="M4 4h13a3 3 0 0 1 3 3v11.5a.5.5 0 0 1-.8.4L16 17H6a2 2 0 0 1-2-2V4z"/><path fill="#818cf8" d="M7 7h9v2H7zM7 11h9v2H7zM7 15h6v2H7z"/>'; return s; }
    function IconEye(){ const s = h('svg',{viewBox:'0 0 24 24', width:32, height:32}); s.innerHTML = '<circle cx="12" cy="12" r="9" fill="#e2e8f0"/><circle cx="12" cy="12" r="4" fill="#6366f1"/>'; return s; }

    function Home(){
      const grid = h('section', {class:'grid'});
      grid.append(
        Tile('Stories','#stories','Write and read entries from everyone (cloud synced).', IconDoc() ),
        Tile('Fun','#fun','Playground of tiny toys. Eyeballs watch your cursor.', IconEye() )
      );
      const card = Card('Experimental website','',
        h('p', {class:'muted', html:'This theme uses glassy panels, neon glows, and star-field grids to nail the "refined alien cruiser" vibe.'})
      );
      return h('div', {}, grid, h('div', {style:'height:12px'}), card);
    }

    // ===== Supabase data funcs =====
    async function dbFetchStories(){
      if(!supabase) return { data: [], error: { message: "Missing Supabase config" } };
      // Order by pen (asc), then created_at (desc)
      return await supabase
        .from('stories')
        .select('id, pen, text, created_at')
        .order('pen', { ascending: true })
        .order('created_at', { ascending: false })
        .limit(200);
    }
    async function dbInsertStory(pen, text){
      if(!supabase) return { error: { message: "Missing Supabase config" } };
      return await supabase.from('stories').insert([{ pen, text }]).select();
    }

    // ========== Stories page ==========
    function Stories(){
      const wrapper = h('div', {});
      let items = [];
      const lastPen = localStorage.getItem(LAST_PEN_KEY) || '';

      // composer
      const form = h('form', {onsubmit: (e)=>{ e.preventDefault(); add(); }});
      const pen = h('input', {placeholder:'Pen name', maxlength:'40', value:lastPen});
      const text = h('textarea', {placeholder:`Share a thought (max ${MAX_LEN} chars)…`, maxlength:String(MAX_LEN)});
      const count = h('span', {class:'count'}, '0/' + MAX_LEN);
      const postBtn = h('button', {class:'btn', type:'submit', disabled:true}, 'Post');
      const reloadBtn = h('button', {class:'btn', type:'button', onclick:()=>load(true)}, 'Refresh');

      text.addEventListener('input', () => { count.textContent = text.value.length + '/' + MAX_LEN; validate(); });
      pen.addEventListener('input', validate);

      function cooldownReady(){
        const last = Number(localStorage.getItem(LAST_POST_AT)||0);
        return Date.now() - last >= 10_000;
      }
      function validate(){
        const ok = pen.value.trim().length>0 && text.value.trim().length>0 && cooldownReady();
        postBtn.disabled = !ok;
      }

      form.append(
        h('div', {class:'grid', style:'grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:12px'},
          pen, text
        ),
        h('div', {class:'row-end', style:'justify-content:space-between; margin-top:10px'},
          count,
          h('div', {class:'row-end'}, postBtn, reloadBtn)
        )
      );

      // list
      const listCard = Card('Community feed', 'Cloud posts sorted by pen & date', h('div', {}, 'Loading…'));
      const listBody = listCard.lastChild; // content container

      // add + duplicate checks
      function isClientDuplicate(p, t){
        const clean = s => s.trim().replace(/\s+/g,' ');
        const now = Date.now();
        return items.some(e =>
          e.pen === clean(p) &&
          e.text === clean(t) &&
          (now - new Date(e.created_at).getTime()) < DUP_WINDOW_MS
        );
      }

      async function add(){
        if(!cooldownReady()){
          const left = Math.ceil((10_000 - (Date.now()-Number(localStorage.getItem(LAST_POST_AT)||0)))/1000);
          alert('Easy there, warp drive cooling down… try again in ~' + left + 's.');
          return;
        }
        const p = pen.value.trim(), t = text.value.trim();
        if(!p || !t) return;
        if(isClientDuplicate(p, t)){ alert('Looks like you just posted that. Not posting a duplicate.'); return; }

        postBtn.innerHTML = '<span class="spin"></span> Posting…';
        postBtn.disabled = true;

        const { data, error } = await dbInsertStory(p, t);
        if(error){
          if(String(error.message).includes('duplicate') || String(error.message).includes('unique')){
            alert('Server says this is a duplicate. Not posting again.');
          } else {
            alert('Could not post: ' + error.message);
          }
          postBtn.textContent = 'Post'; validate();
          return;
        }

        localStorage.setItem(LAST_PEN_KEY, p);
        localStorage.setItem(LAST_POST_AT, String(Date.now()));
        text.value = ''; count.textContent = '0/' + MAX_LEN;

        await load(true); // refresh from server
        postBtn.textContent = 'Posted!';
        setTimeout(()=>{ postBtn.textContent = 'Post'; validate(); }, 900);
      }

      async function load(showSpinner){
        if(showSpinner) listBody.innerHTML = 'Loading…';
        const { data, error } = await dbFetchStories();
        if(error){ listBody.innerHTML = 'Could not load: ' + error.message; return; }
        items = (data || []);
        renderList();
      }

      function renderList(){
        const ul = h('ul', {class:'list'});
        if(items.length === 0){
          ul.append(h('div',{class:'muted'},'No entries yet. Be the first to post!'));
        } else {
          // items already sorted by query: pen asc, date desc
          for(const it of items){
            ul.append(
              h('li',{class:'post', style:'margin-top:12px'},
                h('div',{style:'display:flex; justify-content:space-between; gap:8px; align-items:center'},
                  h('div',{style:'color:#a5b4fc; font-weight:600; letter-spacing:.02em'}, esc(it.pen)),
                  h('time',{class:'muted'}, new Date(it.created_at).toLocaleString())
                ),
                h('div',{style:'margin-top:8px; white-space:pre-wrap'}, esc(it.text))
              )
            );
          }
        }
        listBody.innerHTML = ''; listBody.append(ul);
      }

      // assemble page
      wrapper.append(
        Card('Write a story','Shared across devices via Supabase', form),
        h('div',{style:'height:14px'}),
        listCard
      );

      load(true); // initial fetch
      return wrapper;
    }

    // ========== Fun page (unchanged visuals) ==========
    function Fun(){
      const eyesWrap = h('div',{class:'eyeShell'});
      const eyes = h('div',{class:'eyes'});
      eyesWrap.append(eyes);

      function makeEye(){
        const eye = h('div',{class:'eye'});
        const pupil = h('div',{class:'pupil'});
        const glint = h('div',{class:'glint'});
        eye.append(pupil, glint);
        return {eye, pupil};
      }
      const e1 = makeEye(), e2 = makeEye();
      eyes.append(e1.eye, e2.eye);

      let centers = [];
      function measure(){
        centers = [e1.eye, e2.eye].map(el=>{
          const r = el.getBoundingClientRect();
          return { x: r.left + r.width/2 + window.scrollX, y: r.top + r.height/2 + window.scrollY };
        });
      }
      window.addEventListener('resize', measure);
      setTimeout(measure, 50);

      function move(pageX, pageY){
        if(centers.length<2) measure();
        [e1, e2].forEach((E, i)=>{
          const c = centers[i]; if(!c) return;
          const dx = pageX - c.x, dy = pageY - c.y;
          const ang = Math.atan2(dy, dx);
          const max = 10;
          const px = Math.cos(ang)*max, py = Math.sin(ang)*max;
          E.pupil.style.transform = `translate(calc(-50% + ${px}px), calc(-50% + ${py}px))`;
        });
      }
      window.addEventListener('mousemove', (e)=> move(e.pageX, e.pageY), {passive:true});
      window.addEventListener('touchmove', (e)=> { const t = e.touches[0]; if(t) move(t.pageX, t.pageY); }, {passive:true});

      const toys = h('div', {class:'grid'});
      const pulse = h('div',{class:'pulse', id:'pulse-field', style:'margin-top:16px'});

      toys.append(
        Card('Click-Pulse','Click to charge a pulse',
          h('div',{},
            h('button',{class:'btn', onclick:()=>{
              pulse.style.boxShadow = '0 0 0 0 rgba(99,102,241,0.0)';
              pulse.animate([{boxShadow:'0 0 0 0 rgba(99,102,241,0.0)'},{boxShadow:'0 0 0 24px rgba(99,102,241,0.35)'}],{duration:400, easing:'ease-out'});
            }}, 'Charge'),
            pulse
          )
        ),
        Card('Dice','Random d6 roll', h('button',{class:'btn', onclick:()=> alert('You rolled a ' + (1+Math.floor(Math.random()*6)) + '!')}, 'Roll')),
        Card('Color Drift','Subtle neon shimmer', h('button',{class:'btn', onclick:()=>{ document.documentElement.animate([{filter:'hue-rotate(0deg)'},{filter:'hue-rotate(45deg)'},{filter:'hue-rotate(0deg)'}],{duration:1200}); }}, 'Pulse grid'))
      );

      return h('div',{}, Card('The Eyes','They’ll follow your cursor…', eyesWrap), h('div',{style:'height:14px'}), h('div',{}, toys));
    }

    // router
    function setActive(){ const hash = location.hash || '#home'; document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active')); if(hash.startsWith('#stories')) navStories.classList.add('active'); else if(hash.startsWith('#fun')) navFun.classList.add('active'); else navHome.classList.add('active'); }
    function route(){
      if(!location.hash) location.hash = '#home';
      const hash = location.hash;
      const app = document.getElementById('app');
      app.innerHTML = '';
      if(hash.startsWith('#stories')) app.append(Stories());
      else if(hash.startsWith('#fun')) app.append(Fun());
      else app.append(Home());
      setActiveNav();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    window.addEventListener('hashchange', route);
    route();
  </script>
</body>
</html>
